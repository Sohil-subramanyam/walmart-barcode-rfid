<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Barcode Product Lookup</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/quagga/0.12.1/quagga.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f4f4f4;
            color: #333;
        }
       .container {
            max-width: 800px;
            margin: 0 auto;
            background-color: #fff;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }
        h1 {
            color: #0056b3;
            text-align: center;
            margin-bottom: 30px;
        }
       .scanner-area {
            text-align: center;
            margin-bottom: 20px;
        }
        #interactive.viewport {
            position: relative;
            width: 100%;
            height: 200px; /* Adjust as needed */
            overflow: hidden;
            border: 2px solid #ddd;
            border-radius: 4px;
            background-color: #eee;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        #interactive.viewport video {
            width: 100%;
            height: 100%;
            object-fit: cover; /* Ensures video fills the area */
        }
        canvas {
            display: none; /* Used for processing, not directly displayed */
        }
       .input-section {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-bottom: 20px;
        }
        input[type="text"], input[type="file"] {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 16px;
        }
        button {
            padding: 12px 20px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s ease;
        }
        button:hover {
            background-color: #0056b3;
        }
        #productInfo {
            margin-top: 30px;
            padding: 20px;
            border: 1px solid #e0e0e0;
            border-radius: 4px;
            background-color: #f9f9f9;
            min-height: 100px;
        }
        #productInfo h2 {
            color: #007bff;
            margin-top: 0;
        }
        #statusMessage {
            color: #555;
            margin-top: 10px;
            text-align: center;
            font-weight: bold;
        }
       .error-message {
            color: red;
        }
       .success-message {
            color: green;
        }
       .warning-message {
            color: orange;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Barcode Product Information</h1>

        <div class="scanner-area">
            <div id="interactive" class="viewport">
                <video autoplay="true" preload="auto"></video>
            </div>
            <p id="cameraStatus">Initializing camera...</p>
            <p>Point your camera at a barcode or use the options below.</p>
        </div>

        <div class="input-section">
            <label for="imageUpload">Upload Barcode Image:</label>
            <input type="file" id="imageUpload" accept="image/*">
            <p style="text-align: center;">OR</p>
            <input type="text" id="barcodeInput" placeholder="Enter barcode (UPC, EAN, ISBN) manually">
            <button id="lookupButton">Lookup Product</button>
        </div>

        <p id="statusMessage"></p>

        <div id="productInfo">
            <h2>Product Details</h2>
            <p>Information will appear here after a successful lookup.</p>
        </div>
    </div>

    <script>
        const interactive = document.getElementById('interactive');
        const barcodeInput = document.getElementById('barcodeInput');
        const lookupButton = document.getElementById('lookupButton');
        const imageUpload = document.getElementById('imageUpload');
        const productInfo = document.getElementById('productInfo');
        const statusMessage = document.getElementById('statusMessage');
        const cameraStatus = document.getElementById('cameraStatus');

        let isScanning = false;

        // --- QuaggaJS Initialization for Live Stream ---
        function startCameraScanning() {
            if (isScanning) return; // Prevent multiple camera starts

            cameraStatus.textContent = 'Requesting camera permission...';
            cameraStatus.classList.remove('success-message', 'error-message', 'warning-message');
            statusMessage.textContent = '';
            statusMessage.classList.remove('success-message', 'error-message', 'warning-message');
            productInfo.innerHTML = '<h2>Product Details</h2><p>Information will appear here after a successful lookup.</p>';

            Quagga.init({
                inputStream: {
                    name: "Live",
                    type: "LiveStream",
                    target: interactive, // Or '#interactive'
                    constraints: {
                        width: { min: 640 },
                        height: { min: 480 },
                        facingMode: "environment", // Use 'user' for front camera, 'environment' for back camera
                        aspectRatio: { min: 1, max: 2 }
                    }
                },
                decoder: {
                    readers: ["ean_reader", "upc_reader", "code_128_reader", "code_39_reader", "ean_8_reader", "upc_e_reader", "codabar_reader", "i2of5_reader", "standard_2_of_5_reader", "code_93_reader"],
                    debug: {
                        drawBoundingBox: true, // Draw box around detected barcode
                        showFrequency: false,
                        drawScanline: true, // Draw scanline
                        showPattern: false
                    }
                },
                locate: true // Enable barcode localization
            }, function(err) {
                if (err) {
                    console.error("Error initializing QuaggaJS:", err);
                    let errorMessage = 'Error: Could not start camera. ';
                    if (err.name === 'NotAllowedError') {
                        errorMessage += 'Permission denied. Please allow camera access in your browser settings.';
                    } else if (window.location.protocol!== 'https:') {
                        errorMessage += 'Camera access requires a secure connection (HTTPS). Please serve this page over HTTPS or a local server.';
                    } else {
                        errorMessage += err.message;
                    }
                    cameraStatus.textContent = errorMessage;
                    cameraStatus.classList.add('error-message');
                    isScanning = false;
                    return;
                }
                console.log("QuaggaJS initialization finished. Ready to start.");
                Quagga.start();
                isScanning = true;
                cameraStatus.textContent = 'Camera active. Point at a barcode.';
                cameraStatus.classList.add('success-message');
            });

            Quagga.onDetected(function(result) {
                if (result && result.codeResult && result.codeResult.code) {
                    const barcode = result.codeResult.code;
                    console.log("Barcode detected:", barcode);
                    barcodeInput.value = barcode; // Populate manual input field
                    getProductData(barcode);
                    Quagga.stop(); // Stop scanning after a successful detection
                    isScanning = false;
                    cameraStatus.textContent = 'Scan complete.';
                    cameraStatus.classList.remove('success-message');
                }
            });

            Quagga.onProcessed(function(result) {
                // Optional: You can use this for visual feedback during scanning
                // For example, drawing the bounding box on the video stream
                var drawingCtx = Quagga.canvas.ctx.overlay;
                var drawingCanvas = Quagga.canvas.dom.overlay;

                if (result) {
                    if (result.boxes) {
                        drawingCtx.clearRect(0, 0, parseInt(drawingCanvas.width), parseInt(drawingCanvas.height));
                        result.boxes.filter(function (box) {
                            return box!== result.box;
                        }).forEach(function (box) {
                            Quagga.ImageDebug.drawPath(box, {x: 0, y: 1}, drawingCtx, {color: "green", lineWidth: 2});
                        });
                    }
                    if (result.box) {
                        Quagga.ImageDebug.drawPath(result.box, {x: 0, y: 1}, drawingCtx, {color: "#00F", lineWidth: 2});
                    }
                    if (result.codeResult && result.codeResult.code) {
                        Quagga.ImageDebug.drawPath(result.line, {x: 'x', y: 'y'}, drawingCtx, {color: "red", lineWidth: 3});
                    }
                }
            });
        }

        // --- Handle Image File Upload ---
        imageUpload.addEventListener('change', function(event) {
            const file = event.target.files[0]; // Get the first file
            if (file) {
                if (isScanning) {
                    Quagga.stop(); // Stop live scanning if active
                    isScanning = false;
                    cameraStatus.textContent = 'Camera stopped for image upload.';
                    cameraStatus.classList.remove('success-message');
                }

                statusMessage.textContent = 'Processing image...';
                statusMessage.classList.remove('error-message', 'success-message', 'warning-message');
                productInfo.innerHTML = '<h2>Product Details</h2><p>Decoding barcode from image...</p>';

                const reader = new FileReader();
                reader.onload = function(e) {
                    Quagga.decodeSingle({
                        src: e.target.result,
                        numOfWorkers: 0, // Important for browser environment
                        decoder: {
                            readers: ["ean_reader", "upc_reader", "code_128_reader", "code_39_reader", "ean_8_reader", "upc_e_reader", "codabar_reader", "i2of5_reader", "standard_2_of_5_reader", "code_93_reader"]
                        }
                    }, function(result) {
                        if (result && result.codeResult && result.codeResult.code) {
                            const barcode = result.codeResult.code;
                            console.log("Barcode decoded from image:", barcode);
                            barcodeInput.value = barcode;
                            getProductData(barcode);
                            statusMessage.textContent = 'Barcode detected from image!';
                            statusMessage.classList.add('success-message');
                        } else {
                            console.log("No barcode detected in image.");
                            statusMessage.textContent = 'No barcode found in the uploaded image. Please try another image or enter manually.';
                            statusMessage.classList.add('error-message');
                            productInfo.innerHTML = '<h2>Product Details</h2><p>No barcode found in the uploaded image.</p>';
                        }
                    });
                };
                reader.readAsDataURL(file);
            }
        });

        // --- API Integration (Using RapidAPI Barcode Lookup) ---
        async function getProductData(barcode) {
            productInfo.innerHTML = '<h2>Product Details</h2><p>Loading product information for barcode: <strong>' + barcode + '</strong>...</p>';
            statusMessage.textContent = '';
            statusMessage.classList.remove('error-message', 'success-message', 'warning-message');

            // IMPORTANT SECURITY NOTE:
            // For a production application, you MUST NOT expose your API key directly in client-side code.
            // Instead, you would send the barcode to your own backend server, and your backend
            // would then make the secure API call to the barcode lookup service using your API key.
            // Example: fetch('/api/lookup-barcode', { method: 'POST', body: JSON.stringify({ barcode }) })

            const RAPIDAPI_API_URL = 'https://barcodelookup.p.rapidapi.com/v3/products';
            const RAPIDAPI_HOST = 'barcodelookup.p.rapidapi.com';
            const RAPIDAPI_KEY = 'f4a3f31e5dmshe9f27bd8f405764p12c247jsn9c8bee76ed2c'; // User provided key

            if (RAPIDAPI_KEY === 'YOUR_RAPIDAPI_KEY_HERE' || RAPIDAPI_KEY === 'f4a3f31e5dmshe9f27bd8f405764p12c247jsn9c8bee76ed2c') {
                // The user provided a key, but for a real app, it should be proxied.
                // For this example, we'll use it directly as requested, but keep the warning.
                statusMessage.textContent = 'Warning: API Key is directly in client-side code. For production, use a backend proxy for security.';
                statusMessage.classList.add('warning-message');
            }


            try {
                const response = await fetch(`${RAPIDAPI_API_URL}?barcode=${barcode}&formatted=y`, {
                    method: 'GET',
                    headers: {
                        'X-RapidAPI-Key': RAPIDAPI_KEY,
                        'X-RapidAPI-Host': RAPIDAPI_HOST
                    }
                });

                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({ message: 'No additional error info.' }));
                    let errorMessage = `Failed to retrieve product information. Status: ${response.status}.`;
                    if (response.status === 401) {
                        errorMessage += ' Unauthorized: Your RapidAPI key might be invalid or missing, or you are not subscribed to the API.';
                    } else if (response.status === 404) {
                        errorMessage += ' Not Found: No product information for this barcode in the database.';
                    } else if (response.status === 429) {
                        errorMessage += ' Too Many Requests: You have exceeded your RapidAPI plan quota or rate limit.';
                    } else {
                        errorMessage += ` Message: ${errorData.message |

| 'Unknown error.'}`;
                    }
                    throw new Error(errorMessage);
                }

                const data = await response.json();
                console.log("API Response:", data);

                // RapidAPI Barcode Lookup returns an array of products, even for single barcode lookup
                const product = data.products && data.products.length > 0? data.products[0] : null;

                if (product) {
                    let detailsHtml = '';

                    // Common fields from Barcode Lookup API documentation (Source 22)
                    const fields = [
                        { label: 'Title', key: 'title' },
                        { label: 'Brand', key: 'brand' },
                        { label: 'Manufacturer', key: 'manufacturer' },
                        { label: 'Category', key: 'category' },
                        { label: 'Description', key: 'description' },
                        { label: 'MPN', key: 'mpn' },
                        { label: 'Model', key: 'model' },
                        { label: 'ASIN', key: 'asin' },
                        { label: 'Ingredients', key: 'ingredients' },
                        { label: 'Nutrition Facts', key: 'nutrition_facts' },
                        { label: 'Color', key: 'color' },
                        { label: 'Gender', key: 'gender' },
                        { label: 'Material', key: 'material' },
                        { label: 'Pattern', key: 'pattern' },
                        { label: 'Energy Efficiency Rating', key: 'energy_efficiency_rating' },
                        { label: 'Multipack', key: 'multipack' },
                        { label: 'Size', key: 'size' },
                        { label: 'Length', key: 'length' },
                        { label: 'Width', key: 'width' },
                        { label: 'Height', key: 'height' },
                        { label: 'Weight', key: 'weight' },
                        { label: 'Release Date', key: 'release_date' },
                        { label: 'Contributors', key: 'contributors' }
                    ];

                    fields.forEach(field => {
                        if (product[field.key]) {
                            detailsHtml += `<p><strong>${field.label}:</strong> ${product[field.key]}</p>`;
                        }
                    });

                    // Handle Features (array)
                    if (product.features && product.features.length > 0) {
                        detailsHtml += `<p><strong>Features:</strong></p><ul>`;
                        product.features.forEach(feature => {
                            detailsHtml += `<li>${feature}</li>`;
                        });
                        detailsHtml += `</ul>`;
                    }

                    // Handle Images (array of URLs)
                    let imagesHtml = '';
                    if (product.images && product.images.length > 0) {
                        imagesHtml = '<p><strong>Images:</strong></p>';
                        product.images.forEach(imageUrl => {
                            imagesHtml += `<img src="${imageUrl}" alt="Product Image" style="max-width: 150px; height: auto; margin: 5px; border-radius: 4px;">`;
                        });
                    }

                    // Handle Stores (array of objects)
                    let storesHtml = '';
                    if (product.stores && product.stores.length > 0) {
                        storesHtml = '<p><strong>Available at:</strong></p><ul>';
                        product.stores.forEach(store => {
                            storesHtml += `<li>${store.store_name}: ${store.price} ${store.currency} (<a href="${store.link}" target="_blank">Link</a>)</li>`;
                        });
                        storesHtml += '</ul>';
                    }

                    // Handle Reviews (array of objects)
                    let reviewsHtml = '';
                    if (product.reviews && product.reviews.length > 0) {
                        reviewsHtml = '<p><strong>Reviews:</strong></p>';
                        product.reviews.forEach(review => {
                            reviewsHtml += `
                                <div style="border-bottom: 1px dashed #ccc; padding-bottom: 10px; margin-bottom: 10px;">
                                    <p><strong>${review.title |

| 'No Title'}</strong> (Rating: ${review.rating |

| 'N/A'}/5)</p>
                                    <p>${review.review |

| 'No Review Text'}</p>
                                    <p><small>By ${review.name |

| 'Anonymous'} on ${review.date |

| 'N/A'}</small></p>
                                </div>
                            `;
                        });
                    }


                    productInfo.innerHTML = `
                        <h2>Product Details</h2>
                        <p><strong>Barcode:</strong> ${product.barcode}</p>
                        ${detailsHtml}
                        ${imagesHtml}
                        ${storesHtml}
                        ${reviewsHtml}
                    `;
                    statusMessage.textContent = 'Produ
