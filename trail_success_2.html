<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Smart Barcode Scanner</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/quagga/0.12.1/quagga.min.js"></script>
</head>

<body class="bg-gray-100 min-h-screen flex items-center justify-center">
  <div class="bg-white p-8 rounded-xl shadow-xl w-full max-w-lg">
    <h1 class="text-2xl font-bold mb-4 text-center">üì¶ Smart Barcode Scanner</h1>

    <!-- Upload Image -->
    <div class="mb-4">
      <label class="block font-semibold mb-2">Upload Image with Barcode</label>
      <input type="file" accept="image/*" id="uploadInput" class="block w-full" />
    </div>

    <div class="mb-4">
      <label class="block font-semibold mb-2">Detected Barcode / UPC</label>
      <input id="barcodeInput" class="border border-gray-300 p-2 w-full rounded" placeholder="Auto-filled barcode..." />
    </div>

    <button id="searchBtn" class="bg-blue-600 text-white w-full py-2 rounded hover:bg-blue-700">üîç Search Product</button>

    <div id="result" class="mt-6 text-sm"></div>

    <!-- Hidden Canvas -->
    <canvas id="previewCanvas" class="hidden"></canvas>
  </div>

  <script>
    const uploadInput = document.getElementById('uploadInput');
    const barcodeInput = document.getElementById('barcodeInput');
    const resultDiv = document.getElementById('result');
    const canvas = document.getElementById('previewCanvas');
    const ctx = canvas.getContext('2d');

    uploadInput.addEventListener('change', handleImageUpload);

    function handleImageUpload(event) {
      const file = event.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = function (e) {
        const img = new Image();
        img.onload = () => {
          const zoomFactor = 1.5;
          const angles = [0, 90, 180, 270];
          let detected = false;

          // Draw magnified original image
          canvas.width = img.width * zoomFactor;
          canvas.height = img.height * zoomFactor;
          ctx.clearRect(0, 0, canvas.width, canvas.height);
          ctx.save();
          ctx.scale(zoomFactor, zoomFactor);
          ctx.drawImage(img, 0, 0);
          ctx.restore();
          const originalData = canvas.toDataURL('image/png');

          // Try unenhanced image first
          Quagga.decodeSingle({
            src: originalData,
            numOfWorkers: 0,
            locate: true,
            inputStream: { size: 800 },
            decoder: {
              readers: [
                "upc_reader", "upc_e_reader", "ean_reader",
                "ean_8_reader", "code_128_reader", "code_39_reader",
                "codabar_reader"
              ]
            }
          }, function (result) {
            if (result && result.codeResult) {
              barcodeInput.value = result.codeResult.code;
              resultDiv.innerHTML = `<div class='text-green-600 font-medium'>‚úÖ Detected: ${result.codeResult.code}</div>`;
              detected = true;
            } else {
              tryEnhancedDecode(0);
            }
          });

          const tryEnhancedDecode = (angleIndex = 0) => {
            if (angleIndex >= angles.length || detected) {
              if (!detected) {
                resultDiv.innerHTML = `<div class='text-red-600 font-medium'>‚ö†Ô∏è Could not detect barcode.</div>`;
              }
              return;
            }

            const angle = angles[angleIndex];
            const scaledWidth = (angle === 90 || angle === 270) ? img.height * zoomFactor : img.width * zoomFactor;
            const scaledHeight = (angle === 90 || angle === 270) ? img.width * zoomFactor : img.height * zoomFactor;

            canvas.width = scaledWidth;
            canvas.height = scaledHeight;
            ctx.save();
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.translate(canvas.width / 2, canvas.height / 2);
            ctx.rotate((angle * Math.PI) / 180);
            ctx.scale(zoomFactor, zoomFactor);
            ctx.drawImage(img, -img.width / 2, -img.height / 2);
            ctx.restore();

            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const data = imageData.data;

            for (let i = 0; i < data.length; i += 4) {
              let r = data[i], g = data[i + 1], b = data[i + 2];
              let gray = 0.3 * r + 0.59 * g + 0.11 * b;
              gray = gray < 128 ? gray * 0.8 : gray * 1.2;
              gray = Math.min(255, Math.max(0, gray));
              data[i] = data[i + 1] = data[i + 2] = gray;
            }

            ctx.putImageData(imageData, 0, 0);
            const enhancedData = canvas.toDataURL('image/png');

            Quagga.decodeSingle({
              src: enhancedData,
              numOfWorkers: 0,
              locate: true,
              inputStream: { size: 800 },
              decoder: {
                readers: [
                  "upc_reader", "upc_e_reader", "ean_reader",
                  "ean_8_reader", "code_128_reader", "code_39_reader",
                  "codabar_reader"
                ]
              }
            }, function (result) {
              if (result && result.codeResult) {
                barcodeInput.value = result.codeResult.code;
                resultDiv.innerHTML = `<div class='text-green-600 font-medium'>‚úÖ Detected: ${result.codeResult.code}</div>`;
                detected = true;
              } else {
                tryEnhancedDecode(angleIndex + 1);
              }
            });
          };
        };
        img.src = e.target.result;
      };
      reader.readAsDataURL(file);
    }

    // Product Lookup + Fallback Search
    document.getElementById('searchBtn').addEventListener('click', async () => {
      const barcode = barcodeInput.value.trim();
      if (!barcode) return alert('Enter or upload a barcode');

      resultDiv.innerHTML = '<div class="text-blue-600">Searching...</div>';

      try {
        const response = await fetch(`https://barcodes-lookup.p.rapidapi.com/?barcode=${barcode}`, {
          method: 'GET',
          headers: {
            'X-Rapidapi-Key': 'f4a3f31e5dmshe9f27bd8f405764p12c247jsn9c8bee76ed2c',
            'X-Rapidapi-Host': 'barcodes-lookup.p.rapidapi.com'
          }
        });

        const data = await response.json();
        const p = data.product;
        if (!p) throw new Error();

        resultDiv.innerHTML = `
          <div class='border p-4 rounded bg-gray-50 mt-4'>
            <img src="${p.images?.[0] || ''}" class="w-full h-48 object-contain mb-2" />
            <p><strong>üõí Title:</strong> ${p.title}</p>
            <p><strong>üè≠ Manufacturer:</strong> ${p.manufacturer || 'N/A'}</p>
            <p><strong>üìÑ Description:</strong> ${p.description || 'N/A'}</p>
            <p><strong>üõçÔ∏è Price:</strong> ${p.online_stores?.[0]?.price || 'N/A'} at 
              <a href="${p.online_stores?.[0]?.url}" target="_blank" class="text-blue-600 underline">Store</a>
            </p>
          </div>
        `;
      } catch (err) {
        resultDiv.innerHTML = `
          <div class='text-red-600 font-semibold'>‚ùå Product not found via API.</div>
          <div class="mt-4 text-sm">
            <p class="mb-2">üîç Try searching manually:</p>
            <ul class="list-disc list-inside space-y-1">
              <li><a href="https://www.google.com/search?q=${barcode}" target="_blank" class="text-blue-600 underline">Search on Google</a></li>
              <li><a href="https://www.barcodelookup.com/${barcode}" target="_blank" class="text-blue-600 underline">Search on BarcodeLookup</a></li>
            </ul>
          </div>
        `;
      }
    });
  </script>
</body>

</html>
